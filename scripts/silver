--cust_info
CREATE TABLE silver.crm_cust_info(
cst_id INT,
cst_key varchar(50),
cst_firstname varchar(50),
cst_lastname varchar(50),
cst_marital_status varchar(50),
cst_gndr varchar(50),
cst_create_date date
);
select * from silver.crm_cust_info;
INSERT INTO silver.crm_cust_info (
			cst_id, 
			cst_key, 
			cst_firstname, 
			cst_lastname, 
			cst_marital_status, 
			cst_gndr,
			cst_create_date
		)
		select 
cst_id,
cst_key,
trim(cst_firstname) as firstname,
trim(cst_lastname) as lastname,
case
when upper(trim(cst_gndr)) = 'S' then 'single'
when upper(trim(cst_gndr)) = 'M' then 'married'
else 'n/a'
end as cst_marital_status,
case
when upper(trim(cst_gndr)) = 'M' then 'male'
when upper(trim(cst_gndr)) = 'F' then 'female'
else 'n/a'
end as cst_gndr,
cst_create_date
from
(
select *,
row_number() over(partition by cst_id order by cst_create_date desc) as rank_by_date
from bronze.crm_cust_info
) as t
where rank_by_date = 1 and cst_id is not null;


--prd_info
 create table silver.crm_prd_info(
 prd_id          INT,
    cat_id          NVARCHAR(50),
    prd_key         NVARCHAR(50),
    prd_nm          NVARCHAR(50),
    prd_cost        INT,
    prd_line        NVARCHAR(50),
    prd_start_dt    DATE,
    prd_end_dt      DATE,
    dwh_create_date DATETIME2 DEFAULT GETDATE()
);
INSERT INTO silver.crm_prd_info (
			prd_id,
			cat_id,
			prd_key,
			prd_nm,
			prd_cost,
			prd_line,
			prd_start_dt,
			prd_end_dt
		)
		 select
 prd_id,
 replace(substring(prd_key,1,5),'-','_') as cat_id,
 substring(prd_key,7,len(prd_key)) as prd_key,
 prd_nm,
 isnull(prd_cost,0) as prd_cost,
 case
 when upper(trim(prd_line)) = 'M' then 'Mountain'
 when upper(trim(prd_line)) = 'R' then 'Road'
 when upper(trim(prd_line)) = 'S' then 'Other sales'
 when upper(trim(prd_line)) = 'T' then 'Touring'
 else 'n/a'
 end as prd_line,
 cast(prd_start_dt as date) as prd_start_dt,
 cast(lead(prd_start_dt) over(partition by prd_key order by prd_start_dt) -1 as date) as prd_end_dt
 from bronze.crm_prd_info
 select * from silver.crm_prd_info;

--cust_az12
   CREATE TABLE silver.erp_cust_az12 (
    cid    NVARCHAR(50),
    bdate  DATE,
    gen    NVARCHAR(50)
);
select * from silver.erp_cust_az12;
INSERT INTO silver.erp_cust_az12 (
			cid,
			bdate,
			gen
		)
        select
case
 when cid like 'nas%' then substring(cid,4,len(cid))
 else cid
 end  as cid,
 case
 when bdate > getdate() or bdate< '1925-10-17' then null
 else bdate
 end as bdate,
 case
 when upper(trim(gen)) in ('M' , 'MALE') THEN 'MALE'
 when upper(trim(gen)) in ('F' , 'FEMALE') THEN 'FEMALE'
 else 'n/a'
 end as gen
 from bronze.erp_cust_az12;

--

